{% extends 'base/base.html' %}
{% load static %}

{%block ref%}
<link rel="stylesheet" href="{% static 'css/post.css' %}">
{%endblock%}

{% block content %}
<script src="{% static 'editor/editormd.js' %}"></script>
<script src="{% static 'editor/lib/marked.min.js' %}"></script>
<script src="{% static 'editor/lib/prettify.min.js' %}"></script>
<script src="{% static 'blog/js/default.js' %}"></script>

<script src="{% static 'layui/lay/modules/laypage.js' %}"></script>
<div class="container" id="blog-detail-comment-area">
    <div class="blog-detail-area">
      <h1 class="post-title">{{post.title}}</h5>
      <div class="post-stats">
        <div class="post-stats-item like-post-btn">
            <a role="button" id="like-post-link">
              {%if user in post.liked_by.all%}
                <img id="like-post" src="{%static 'img/icons/red_heart.png'%}" width=20 height=20 alt="">
              {%else%}
                <img id="like-post" src="{%static 'img/icons/grey_heart.png'%}" width=20 height=20 alt="">
              {%endif%}
            </a>
            <div class="like-post-count">{{post.liked_by.count}}</div>
        </div>
        <div class="post-stats-item mark-post-btn">
          <a role="button" id="mark-post-link">
            {%if user in post.marked_by.all%}
              <img id="mark-post" src="{%static 'img/icons/star.png'%}" width=20 height=20 alt="">
            {%else%}
              <img id="mark-post" src="{%static 'img/icons/grey_star.png'%}" width=20 height=20 alt="">
            {%endif%}
          </a>
          <div class="mark-post-count">{{post.marked_by.count}}</div>
        </div>
        <div class="post-stats-item">
          <img id="view-post" src="{%static 'img/icons/view.png'%}" width=20 height=20 alt="">  <div class="view-post-count">{{post.viewed_count}}</div>
        </div>
      </div>
      <div class="last-edit-time">
        最后编辑时间 {{post.update_time}}
      </div>
      <div id="post-content">
        <!-- Server-side output Markdown text -->
        <textarea style="display:none;">{{post.content|safe}}</textarea>             
      </div>
    </div>
    <div class="post-operation-btn-group">
      {%if user.is_authenticated%}
      <button type="button" id="post-comment-btn"><img src="{%static 'img/icons/comment.png'%}" width=20 height=20 alt=""></button>
      {%endif%}
      {%ifequal user post.author%}
        <a  href="{%url 'post_update' pk=post.pk%}" role="button"><img src="{%static 'img/icons/edit.png'%}" width=20 height=20 alt=""></a>
        <button type="button" id="delete-post-btn"><img src="{%static 'img/icons/trash_bin.png'%}" width=20 height=20 alt=""></button>
      {%endifequal%}
    </div>
    <div class="comment-list"></div>
    <div class="comment-section">
    </div>
  </div>

{% csrf_token %}
<script type="text/javascript">
    $(function() {
	    var testView = editormd.markdownToHTML("post-content", {
            // markdown : "[TOC]\n### Hello world!\n## Heading 2", // Also, you can dynamic set Markdown text
            htmlDecode : true,  // Enable / disable HTML tag encode.
            htmlDecode : "style,script,iframe",  // Note: If enabled, you should filter some dangerous HTML tags for website security.
        });
    });

    function generateCommentItem(data) {
        var text = "";
        text += "<div class=\"comment-item\" id=\"comment-item_PK_PLACEHOLDER\">".replace("PK_PLACEHOLDER", data.pk);
        text += "  <div class=\"card-header comment-header\">";
        text += "    <div class=\"d-flex w-100 justify-content-between\">";
        text += "      发布者: 我";
        text += "    </div>";
        text += "  </div>";
        text += "    <h6 class=comment-title\">";
        text += "      <small>" + data.create_time + "</small>";
        text += "    </h6>";
        text += "    <p class=\"comment-text\"><p class=\"mb-1\">" + data.content +"</p>";
        text += "    <div class=\"comment-actions\">";
        text += "        <div class=\"comment-action-item like-comment\">";
        text += "          <a role=\"button\" class=like-comment-btn data-href=\"{% url 'like_comment' pk=123 %}\">".replace("123", data.pk);
        text += "              <img src=\"{%static 'img/icons/thumb_up_unselected.png'%}\" class=\"like-comment\" width=20 height=20>".replace("123", data.pk).replace("thumb_up_unselected.png", data.is_liked?"thumb_up_selected.png":"thumb_up_unselected.png");
        text += "          </a>";
        text += "          <div id=\"comment-like-number_" + data.pk + "\" class=comment-action-item>" + data.likes_count + "</div>";
        text += "        </div>";
        text += "        ";
        text += "        <div class=\"comment-action-item dislike-comment\">";
        text += "          <a role=\"button\" class=dislike-comment-btn data-href=\"{% url 'dislike_comment' pk=123 %}\">".replace("123", data.pk);
        text += "              <img src=\"{%static 'img/icons/thumb_down_unselected.png'%}\" class=\"dislike-comment\" id=\"dislike-123\" width=20 height=20>".replace("123", data.pk).replace("thumb_down_unselected.png", data.is_disliked?"thumb_up_selected.png":"thumb_down_unselected.png");
        text += "          </a>";
        text += "          <div id=\"comment-dislike-number_" + data.pk + "\" class=comment-action-item>"  + data.dislikes_count + "</div>";
        text += "        </div>";
        text += "        <div class=\"comment-action-item remove-comment\">";
        text += "          <button type=\"button\" data-href=\"{%url 'comment_remove' pk=123%}\" class=\"delete-comment-btn\"><img src=\"{%static 'img/icons/trash_bin.png'%}\" width=20 height=20></button>".replace("123", data.pk);
        text += "        </div>";
        text += "    </div>";
        text += "</div>";
        return text;
      }

    var csrf = $('input[name="csrfmiddlewaretoken"]').val();
    function EventListener() {
      this.init = function() {
        this.likePost();
        this.markPost();
        this.makeComment();
        this.deletePost();
        {% comment %} this.likeComment();
        this.dislikeComment(); {% endcomment %}
        {% comment %} this.getCommentList(); {% endcomment %}
      }

      this.likePost = function() {
        $("#like-post-link").click(function() {
          $.ajax(
            {
              type: "GET",
              url: '{%url "like_post" pk=123%}'.replace("123", '{{post.pk}}'),
              success: function(res) {
                if (res.result==1) {
                  $("#like-post").prop("src", '{%static "img/icons/red_heart.png"%}');
                  var likePostCount = Number($(".like-post-count").text());
                  $(".like-post-count").text(likePostCount+1);
                }
                else {
                  $("#like-post").prop("src", '{%static "img/icons/grey_heart.png"%}');
                  var likePostCount = Number($(".like-post-count").text());
                  $(".like-post-count").text(likePostCount-1);
                }
              }
            }
          )
        })
      };
      this.markPost = function() {
        $("#mark-post-link").click(function() {
          $.ajax(
            {
              type: "GET",
              url: '{%url "mark_post" pk=123%}'.replace("123", '{{post.pk}}'),
              success: function(res) {
                if (res.result==1) {
                  $("#mark-post").prop("src", '{%static "img/icons/star.png"%}');
                  var markPostCount = Number($(".mark-post-count").text());
                  $(".mark-post-count").text(markPostCount+1);
                }
                else {
                  $("#mark-post").prop("src", '{%static "img/icons/grey_star.png"%}');
                  var markPostCount = Number($(".mark-post-count").text());
                  $(".mark-post-count").text(markPostCount-1);
                }
              }
            }
          )
        })
      };
      this.makeComment = function() {
        //
        let that = this;
        $("#post-comment-btn").click(function() {
          $.get('{%url "comment_new" pk=123%}'.replace("123", '{{post.pk}}'), {}, function(str) {
            layer.prompt(
              {
                title: "发表您的见解",
                fixed: false,
                resize: false,
                content: str,
                btn: null,
                success: function() {
                  $("#save-comment").click(function() {
                    $.post({
                      url: '{%url "comment_new" 123%}'.replace('123', '{{post.pk}}'),
                      data: {
                        "content": $("#comment-content").val(),
                        "csrfmiddlewaretoken": csrf,
                      },
                      success: function(res) {
                        var data = res.data;
                        var text = generateCommentItem(data);
                        $(".comment-list").append(text);
                        that.likeComment();
                        that.dislikeComment();
                        layer.closeAll();
                      }
                    })
                  })
                }
              },
              function(value, index, elem) {
                alert(value);
              }
            )
          })


        })
      };
      this.editPost = function() {
        $("#like-post-link").click(function() {
          
        })
      };
      this.deletePost = function() {
        $("#delete-post-btn").click(function() {
          console.log(csrf);
            layer.open({
                title: "提示",
                content: "确定要删除吗？此操作不可撤销",
                btn: ["删除", "取消"],
                yes: function() {
                    $.ajax({
                        url: "{%url 'post_remove' pk=123%}".replace("123", '{{post.pk}}'),
                        method: "delete",
                        headers: {
                            'X-CSRFToken': csrf
                        },
                        success: function(res) {
                            if (res.result != 1) {
                                layer.msg(res.msg, {
                                    time: 2000
                                });
                            }
                            else {
                                window.location.href = document.referrer;
                                layer.msg(res.msg, {
                                    time: 2000
                                }); 

                            }
                        }
                    })
                }
            })
        })
      };
      this.likeComment = function() {
        console.log("Like comment!");
        $(".like-comment-btn").click(function() {
          var url = $(this).data("href");
          var clickedBtn = $(this);
          $.get({
            url: url,
            success: function(res) {
              console.log(res);
              // 如果已经点灭，提示不能操作
              if (res.result == -1) {
                  layer.msg("您已经点过灭了！:)", {
                    time: 2000
                  })
              }
              // 如果已经点赞，取消点赞
              else if (res.result == 1) {
                var prevLikes = $("#comment-like-number_" + res.pk).text();
                $("#comment-like-number_" + res.pk).text(Number(prevLikes)-1);
                clickedBtn.find("img").prop("src", '{%static "img/icons/thumb_up_unselected.png"%}');
              }
              // 如果没有点赞，返回0，加入点赞
              else {
                var prevLikes = $("#comment-like-number_" + res.pk).text();
                $("#comment-like-number_" + res.pk).text(Number(prevLikes)+1);
                clickedBtn.find("img").prop("src", '{%static "img/icons/thumb_up_selected.png"%}');
              }
            }
          })
        })
      }; 
      this.dislikeComment = function() {
        $(".dislike-comment-btn").click(function() {
          var url = $(this).data("href");
          var clickedBtn = $(this);
          $.get({
            url: url,
            success: function(res) {
              if (res.result == -1) {
                  layer.msg("您已经点过赞了！:)", {
                    time: 2000
                  })
              }
              else if (res.result == 1) {
                var prevDislikes = $("#comment-dislike-number_" + res.pk).text();
                $("#comment-dislike-number_" + res.pk).text(Number(prevDislikes)-1);
                clickedBtn.find("img").prop("src", '{%static "img/icons/thumb_down_unselected.png"%}');
              }
              else {
                var prevDislikes = $("#comment-dislike-number_" + res.pk).text();
                $("#comment-dislike-number_" + res.pk).text(Number(prevDislikes)+1);
                clickedBtn.find("img").prop("src", '{%static "img/icons/thumb_down_selected.png"%}');
              }
            }
          })
        })
      };
      this.deleteComment = function() {

      };
      this.getCommentList = function() {
        $.get({
          url: '{%url "comment_list" pk=123%}'.replace('123', '{{post.pk}}'),
          success: function(data) {
            text = "";
            var comments = data.data; 
            for (var i=0; i <comments.length; i++) {

            }
          }
        })
      }
    }

    var commentCount, commentLimit, firstCommentPageData;
    var listener = new EventListener();
    listener.init();
    $.get({
      url: '{%url "comment_list" pk=123%}'.replace("123", '{{post.pk}}'),
      success: function(res) {
        commentCount = res.total_comment;
        commentLimit = res.limit;
        firstCommentPageData = res.data;
        var laypage = layui.laypage;

        var text = "";
        for (var i=0; i<firstCommentPageData.length; i++) {
          text += generateCommentItem(firstCommentPageData[i]);
        }
        //执行一个laypage实例
        laypage.render({
          elem: document.getElementsByClassName('comment-section')[0] //注意，这里的 test1 是 ID，不用加 # 号
          , count: commentCount //数据总数，从服务端得到
          , limit: commentLimit
          , jump: function(obj, first) {
              $.get({
                url: '{%url "comment_list" pk=123%}'.replace("123", '{{post.pk}}') + '?page=' + obj.curr,
                success: function(res) {
                  var text = "";
                  var data = res.data;
                  for (var i=0; i<data.length; i++) {
                    text += generateCommentItem(data[i]);
                  }
                  $(".comment-list").html(text);
                  listener.likeComment();
                  listener.dislikeComment();
                }
              })
          }
        });
      }
    })

</script>
{% endblock %}
